# GitLab Helm Chart Values
# Configured for k3d master cluster with NodePort services
# Access via localhost ports (works with Tailscale SSH tunneling)

global:
  # Core domain configuration - uses localhost
  hosts:
    domain: localhost
    https: false
    gitlab:
      name: localhost
      https: false
    registry:
      name: localhost
      https: false
    minio:
      name: localhost
      https: false

  # Edition: ce (Community) or ee (Enterprise)
  edition: ce

  # Time zone
  time_zone: UTC

  # Ingress configuration - DISABLED (using NodePort instead)
  ingress:
    enabled: false
    configureCertmanager: false

  # Service configuration - NodePort for all services
  service:
    type: NodePort

# NGINX Ingress Controller - DISABLED (using NodePort services)
nginx-ingress:
  enabled: false

# PostgreSQL Database
postgresql:
  install: true
  metrics:
    enabled: false
  resources:
    requests:
      cpu: 500m
      memory: 1Gi
    limits:
      memory: 2Gi
  persistence:
    size: 20Gi
    storageClass: local-path

# Redis
redis:
  install: true
  metrics:
    enabled: false
  master:
    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        memory: 512Mi
  persistence:
    size: 5Gi
    storageClass: local-path

# MinIO (Object Storage)
minio:
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 512Mi
  persistence:
    size: 20Gi
    storageClass: local-path

# GitLab Components
gitlab:
  # Webservice (main GitLab application)
  webservice:
    minReplicas: 1
    maxReplicas: 1
    service:
      type: NodePort
      workhorse:
        nodePort: 30082
    resources:
      requests:
        cpu: 500m
        memory: 2Gi
      limits:
        memory: 4Gi
    workhorse:
      resources:
        requests:
          cpu: 100m
          memory: 100Mi
        limits:
          memory: 200Mi
  
  # Sidekiq (background jobs)
  sidekiq:
    minReplicas: 1
    maxReplicas: 1
    resources:
      requests:
        cpu: 500m
        memory: 1Gi
      limits:
        memory: 2Gi
  
  # Gitaly (Git repository storage)
  gitaly:
    resources:
      requests:
        cpu: 100m
        memory: 512Mi
      limits:
        memory: 1Gi
    persistence:
      size: 50Gi
      storageClass: local-path
  
  # GitLab Shell (SSH access)
  gitlab-shell:
    minReplicas: 1
    maxReplicas: 1
    service:
      type: NodePort
      nodePort: 30022
    resources:
      requests:
        cpu: 50m
        memory: 64Mi
      limits:
        memory: 128Mi
  
  # Migrations
  migrations:
    resources:
      requests:
        cpu: 250m
        memory: 512Mi
      limits:
        memory: 1Gi

# Container Registry
registry:
  enabled: true
  service:
    type: NodePort
    nodePort:
      http: 30050
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      memory: 256Mi

# GitLab Runner
gitlab-runner:
  install: true
  # Override GitLab URL to use internal Kubernetes service
  gitlabUrl: http://gitlab-webservice-default.gitlab.svc.cluster.local:8181
  runners:
    # Enable privileged mode for Docker-in-Docker
    privileged: true
    # Runner configuration
    config: |
      [[runners]]
        [runners.kubernetes]
          namespace = "{{.Release.Namespace}}"
          image = "alpine:latest"
          privileged = true
        [[runners.kubernetes.volumes.empty_dir]]
          name = "docker-certs"
          mount_path = "/certs/client"
          medium = "Memory"
    # Resources for runner pods
    resources:
      requests:
        cpu: 100m
        memory: 128Mi
      limits:
        memory: 256Mi

# Prometheus (monitoring) - disabled for local dev
prometheus:
  install: false

# Grafana (dashboards) - disabled for local dev
grafana:
  enabled: false

# GitLab Exporter - keep minimal
gitlab-exporter:
  enabled: true
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      memory: 128Mi

# Shared secrets configuration
shared-secrets:
  resources:
    requests:
      cpu: 50m
      memory: 50Mi
    limits:
      memory: 100Mi
